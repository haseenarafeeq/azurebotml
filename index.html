<!DOCTYPE html>
<html>


<head>

    <title>UNIVERSITY OF LINCOLN</title>



    <!-- BASE CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/menu.css" rel="stylesheet">
</head>

<body>

    <h2 style="text-align: center;" class="body-h2"> UNIVERSITY OF LINCOLN DEMO CHATBOT PORTAL</h2>
    <h4 style="width: 50%;margin:auto;color:black;font-weight:800">
        I am a chatbot designed to answer queries related to university of Lincoln admission enquiry, course information and location details. This chat will provide url for each predicted intent. All answers are subjected to university of Lincoln website.
    </h4>
    <table>
        <thead>
            <tr>
            <th>Algorithm</th>
            <th>Accurary</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Naive</td>
                <td id="naive-accuracy"></td>
            </tr>
            <tr>
                <td>LSTM</td>
                <td id="lstm-accuracy"></td>
            </tr>
        </tbody>
    </table>


    <!-- Chat box markup -->
    <div class="container">
        <div class="chat-container LSTM-container">
            <div class="chat-header">
                <span> Chat Box LSTM</span>
                <img id="closeButton-LSTM" src="./img/icons8-close-window-64.png" alt="">
                <img id="minimizeButton-LSTM" src="./img/icons8-compress-48.png" alt="">
            </div>
            <div class="chat-body" id="chat-body">

            </div>
            <div class="chat-footer" id="footer-LSTM">
                <grammarly-editor-plugin>
                    <input class="chat-input" id="chat-input" type="text" placeholder="Type your message" />
                </grammarly-editor-plugin>

                <div class="img-div">
                    <img src="./img/icons8-send-message-90.png" id="send-icon" style="height:20px" alt="">
                </div>
                <button style="margin-left: 1%;" id="voice-search-button"><img style="height:10px" src="./img/mic.png"
                        alt=""></button>
            </div>
        </div>
    </div>



    <!-- Common scripts -->
    <!-- <script src="https://code.jquery.com/jquery-3.7.0.js" integrity="sha256-JlqSTELeR4TLqP0OG9dxM7yDPqX1ox/HfgiSLBj8+kM=" crossorigin="anonymous"></script>
    <script src="https://cdn.tiny.cloud/1/r49rcj4uxmtj9e4upy2672lxxrbmy5a0e76s9xwda01tpsw0/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/@grammarly/editor-sdk?clientId=client_ACCZJfvJuhUtY5xy46XZbJ"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        let lstm = false;
        let question = '';
        const LSTMContainer = document.querySelector('.LSTM-container');
        const chatboxElement = document.querySelector('#chat-body');
        const userInputElement = document.querySelector('#chat-input');
        const closeButtonLSTM = document.getElementById('closeButton-LSTM');
        const minimizeButtonLSTM = document.getElementById('minimizeButton-LSTM');
        const sendIcon = document.querySelector('#send-icon');
        const footerLSTM = document.getElementById('footer-LSTM');
        const subjects = ['admission_details', 'course-information', 'location' ,'greeting']
        const closeButtons = {
            closeLSTM: false,
        }
        // Attach a click event to the close button
        closeButtonLSTM.addEventListener('click', (event) => {
            colseAndMinimize(event, 'closeLSTM'); // Call your function here
        });

        // Attach a click event to the minimize button
        minimizeButtonLSTM.addEventListener('click', (event) => {
            colseAndMinimize(event, 'closeLSTM'); // Call your function here
        });

        function colseAndMinimize(event, button) {
            closeButtons[button] = !closeButtons[button];
            if (closeButtons[button] && button === 'closeLSTM') {
                closeButtonLSTM.style.display = 'none';
                minimizeButtonLSTM.style.display = 'inline';
                footerLSTM.style.display = 'none';
                chatboxElement.style.display = 'none';
                LSTMContainer.style.height = '40px'
            }
            if (!closeButtons[button] && button === 'closeLSTM') {
                closeButtonLSTM.style.display = 'inline';
                minimizeButtonLSTM.style.display = 'none';
                footerLSTM.style.display = 'flex';
                chatboxElement.style.display = 'block';
                LSTMContainer.style.height = '400px'
            }
        }
        async function getChat(message) {
            try {
                let answer;
                const url =
                    'https://uol-language-service.cognitiveservices.azure.com/language/:query-knowledgebases';

                const subscriptionKey = '149150bdbfce4d9c978abf44a0a7c879';
                const projectName = 'uolbot';
                const apiVersion = '2021-10-01';
                const deploymentName = 'test';

                const data = {
                    top: 3,
                    question: message,
                    includeUnstructuredSources: true,
                    confidenceScoreThreshold: '0.5',
                    answerSpanRequest: {
                        enable: true,
                        topAnswersWithSpan: 1,
                        confidenceScoreThreshold: '1'
                    },
                };
                return await requestFunction(url, data, subscriptionKey, projectName, apiVersion, deploymentName)
            } catch (error) {
                console.log(error);
            }
        }
        async function getIntents(query) {
            const url =
                'https://uol-language-service.cognitiveservices.azure.com/language/:analyze-conversations?api-version=2022-10-01-preview';

            const subscriptionKey = '149150bdbfce4d9c978abf44a0a7c879';
            const requestId = '4ffcac1c-b2fc-48ba-bd6d-b69d9942995a';

            const headers = {
                'Ocp-Apim-Subscription-Key': subscriptionKey,
                'Apim-Request-Id': requestId,
                'Content-Type': 'application/json'
            };

            const data = {
                kind: 'Conversation',
                analysisInput: {
                    conversationItem: {
                        id: 'PARTICIPANT_ID_HERE',
                        text: query,
                        modality: 'text',
                        language: 'en',
                        participantId: 'PARTICIPANT_ID_HERE'
                    }
                },
                parameters: {
                    projectName: 'UniversityOfLincolnChatBot',
                    verbose: true,
                    deploymentName: 'deployment1',
                    stringIndexType: 'TextElement_V8'
                }
            };
            return new Promise((resolve, reject) => {
                axios.post(url, data, {
                        headers
                    })
                    .then(response => {
                        let intent = response.data.result.prediction.intents[0].category;
                        resolve(intent)
                    })
                    .catch(error => {
                        console.error(error);
                        reject(error)
                    });
            })
        }

        getSpeechText();

        sendIcon.addEventListener('click', onClickSendIcon);
        userInputElement.addEventListener('keydown', onEnter);
        async function onEnter(event) {
            if (event.key === 'Enter') {
                console.log(event);
                let id = event.srcElement.id;
                let userMessage;
                lstm = true;
                userMessage = userInputElement.value;
                question = userMessage;
                addMessage(userMessage, 'user-message');
                userInputElement.value = '';
                getIntents(userMessage).
                then(async res => {
                        console.log(res, 'response');
                        if (res === 'Not-related-to-UniversityOfLincoln') {
                            let message =
                                "I am a chat bot designed to answer queries related to admission,location,course information at University of Lincoln for post graduate students.";
                            addMessage(message, 'bot-message');
                        } else {
                            // Simulate bot response (replace with your own logic to retrieve the answer)
                            let naiveIntent = await getNaiveResponse(question);
                            let intentMsg = 'You have asked about ' + naiveIntent;
                             addMessage(intentMsg, 'bot-message');
                            if (subjects.includes(naiveIntent)) {
                                await getChat(userMessage);
                            } else {
                                let message =
                                    "I am a chat bot designed to answer queries related to admission,location,course information at University of Lincoln for post graduate students.";
                                addMessage(message, 'bot-message');
                            }
                        }
                    })
                    .catch((err) => {
                        console.log(err);
                    });
            }
        }
        async function onClickSendIcon(event) {
            let id = event.srcElement.id;
            let userMessage;
            lstm = true;
            userMessage = userInputElement.value;
            question = userMessage;
            addMessage(userMessage, 'user-message');
            userInputElement.value = '';
            getIntents(userMessage).
            then(async res => {
                    console.log(res, 'response');
                    if (res === 'Not-related-to-UniversityOfLincoln') {
                        let message =
                            "I am a chat bot designed to answer queries related to admission,location,course information at University of Lincoln for post graduate students.";
                        addMessage(message, 'bot-message');
                    } else {
                        // Simulate bot response (replace with your own logic to retrieve the answer)
                        let naiveIntent = await getNaiveResponse(question);
                        let intentMsg = 'You have asked about ' + naiveIntent;
                        addMessage(intentMsg, 'bot-message');
                        if (subjects.includes(naiveIntent)) {
                            await getChat(userMessage);
                        } else {
                            let message =
                                "I am a chat bot designed to answer queries related to admission,location,course information at University of Lincoln for post graduate students.";
                            addMessage(message, 'bot-message');
                        }
                    }
                })
                .catch((err) => {
                    console.log(err);
                });
        }

        function convertUrlsToLinks(message) {
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            const replacedText = message.replace(urlRegex, '<a href="$&" target="_blank">$&</a>');
            return replacedText;
        }

        function addMessage(message, className) {
            const messageElement = document.createElement('div');
            messageElement.innerHTML = convertUrlsToLinks(message);
            messageElement.classList.add('message', className);
            if (!lstm) {
                chatboxElement1.appendChild(messageElement);
                chatboxElement1.scrollTop = chatboxElement.scrollHeight;
            } else {
                chatboxElement.appendChild(messageElement);
                chatboxElement.scrollTop = chatboxElement.scrollHeight;
            }


        }

        async function requestFunction(url, data, subscriptionKey, projectName, apiVersion, deploymentName) {
            axios.post(
                    `${url}?projectName=${projectName}&api-version=${apiVersion}&deploymentName=${deploymentName}`,
                    data, {
                        headers: {
                            'Content-Type': 'application/json',
                            'Ocp-Apim-Subscription-Key': subscriptionKey
                        }
                    })
                .then(response => {
                    console.log(response.data.answers);
                    let answer = response.data.answers[0].answer;
                    console.log(answer)
                    if (answer ===
                        'I am a chatbot designed to answer queries related to admission faculty info and location'
                    ) {
                        let algorithm = lstm ? 'LSTM' : null
                        getMlResponse(question, algorithm)
                    } else {
                        addMessage(answer, 'bot-message');
                    }

                })
                .catch(error => {
                    console.error(error);
                });
        }

        function getMlResponse(question, algorithm) {
            axios.get(
                    `http://localhost:8080/answer?question=${question}&algorithm=${algorithm}`,
                )
                .then(data => {
                    console.log(data.data.response);
                    let answer = data.data.response;
                    let accuracy  =  data.data.accuracy;
                    document.getElementById('lstm-accuracy').innerText = accuracy + '%'
                    addMessage(answer, 'bot-message');
                })
                .catch(error => {
                    console.error(error);
                });
        }

        function getNaiveResponse(question, algorithm) {
            return new Promise((resolve, reject) => {
                axios.get(
                        `http://localhost:8080/answer?question=${question}`,
                    )
                    .then(data => {
                        console.log(data.data.response);
                        let intent = data.data.response;
                        let accuracy  =  data.data.accuracy;
                        document.getElementById('naive-accuracy').innerText = accuracy + '%'
                        resolve(intent);
                    })
                    .catch(error => {
                        console.error(error);
                        reject(error);
                    });
            })
        }

        function getSpeechText() {
            // Check if the browser supports the Web Speech API
            isLSTM = false;
            if ('webkitSpeechRecognition' in window) {
                let recognition; // Declare recognition object

                // Function to create a new instance of recognition
                function createRecognition() {
                    recognition = new webkitSpeechRecognition();
                    recognition.continuous = false;
                    recognition.interimResults = false;
                    recognition.lang = 'en-US'; // Set the language for speech recognition

                    // Handle speech recognition results
                    recognition.onresult = function (event) {
                        const transcript = event.results[0][0].transcript;
                        const userInputElement = document.querySelector('.chat-input');
                        userInputElement.value = transcript;

                        recognition.stop();
                    };

                    // Handle speech recognition errors
                    recognition.onerror = function (event) {
                        console.error('Speech recognition error:', event.error);
                    };
                }

                // Call the createRecognition function to set up the initial recognition object
                createRecognition();
                const voiceSearchButton = document.querySelector('#voice-search-button');

                voiceSearchButton.addEventListener('click', function (event) {
                    isLSTM = true;
                    recognition.start();
                });

                // Handle the recognition end event to create a new instance of recognition
                recognition.onend = function () {
                    createRecognition();
                };
            } else {
                console.error('Web Speech API is not supported in this browser.');
            }
        }
    </script>

</body>


</html>